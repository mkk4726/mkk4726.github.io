---
title: "[Visuworks] Segmentation Model"
date: ""
excerpt: "출혈관련 병변 탐지 모델 개발"
category: "Career"
tags: ["Computer Vision", "Segmentation"]
---

- 기간 : 2024.04 ~ 2024.06 (3개월)
- 역할 : 출혈 관련 병변 탐지를 위한 segmentation model 개발 및 모델 서빙, 모델 추론 관련 API 개발

---

# 프로젝트 개요

눈의 안쪽 사진인 안저사진을 통해 눈의 질병들을 진단할 수 있습니다.
이때 질병들의 증상인 병변들을 눈으로 확인하는 과정이 꽤나 번거로웠기 때문에, 이를 모델을 통해 찾아서 보여주고자 했습니다.
여러가지 탐지 중에 출혈과 관련된 병변을 탐지하는 모델을 맡아 개발을 진행했습니다.
Aiffel에서 했던 프로젝트의 결과(기본적인 Segmentation 모델 개발, 전처리 방법 고도화, MTL)를 고도화하는 방향으로 진행했습니다. 

모델 개발 후에는 온프레미스로 GPU에 모델을 서빙하고 관련된 API를 개발하는 부분도 같이 진행했습니다.

프로젝트를 진행하면서 contrastive learning을 통한 pretraining 방법을 이해할 수 있었고, Triton Server와 같은 모델 서빙 도구를 활용하여 실제 서빙 환경에서의 경험을 쌓을 수 있었습니다.

하지만 한계도 분명한 프로젝트였습니다. 일반화하긴 어렵겠지만 의료분야에 기술 도입의 어려움을 알 수 있었고, 진로에 대한 생각이 바뀌게 된 계기이기도 합니다.

---

# 문제해결과정

프로젝트를 진행하면서 고민했던 부분은 2가지인데요.
1. 모델의 성능을 어떻게 올릴까?
2. 모델 서빙은 어떻게 하는걸까?

각각 어떻게 해결해나갔는지 간단하게 정리해봤습니다.
그리고 프로젝트가 끝나면서 어떤 한계점을 마주했는지도 정리했습니다.

---

# 모델 성능을 올리기 위해서 시도했던 것들

모델의 성능을 올리기 위해 시도한 방향은 비지도 학습을 통해 사전학습을 시키는 것입니다.

데이터셋이 약 1500개정도로 적었고, 문제의 특성상 데이터셋 안에서 레이블이 있는 경우가 80%, 있어도 이미지에서 차지하는 비율은 매우 작았습니다.
하지만 안저사진 자체는 1만개 이상으로 굉장히 많았고, 이를 활용해 성능을 향상시키고자 했습니다.

CLIP과 같은 모델이 contrastive learning을 통해 좋은 결과를 보이고 있었고, 이를 이미지 분야에서도 적용하는 SimCLR 같은 컨셉이 있었습니다.
또한 병변탐지 모델에도 이를 적용한 논문들이 있었기 때문에 이를 적용해 성능을 향상시키고자 했습니다.

1년이 지난 시점에서 적어서 구체적인 수치가 기억은 안나지만, 결과적으로 성능향상이 되었던 걸로 기억합니다.
그 과정에서 시행착오가 많았지만, 논문을 보고 구현했던 경험이 실력을 향상시키는데 정말 많은 도움이 되었습니다.

---

## 모델 선택: U-Net 기반

모델은 Aiffel 프로젝트를 진행하면서 얻은 결과를 바탕으로 사용했습니다.
이때 실험결과를 통해, 많은 의료 논문에서 Unet이 작은 병변을 탐지하는데 유리하다고 했던 부분을 확인할 수 있었고, CLAHE와 같은 이미지 전처리 방법을 고도화했습니다.

Unet 구조로 모델을 설계하고, Encoder를 풍부하게 하기 위한 방법들을 적용하려고 했습니다.
이를 위해 Contrastive Learning (이후 CL)이나 Multi-Task Learning(이후 MTL) 등을 적용했습니다.

---

## Contrastive Learning 기반 사전학습

성능을 향상시키기 위해 일반화된 패턴을 먼저 학습시키는, pretraining 방법을 사용하려고 했습니다.

먼저 많이 사용되는 ImageNet기반 사전학습 가중치를 사용했습니다.
하지만 실험을 해보니 성능향상이 크게 되지 않았고, 그 이유로 안저사진이 ImageNet의 사진들과 많이 다르기 때문이라고 이해할 수 있었습니다.

따라서 안저사진 자체로 사전학습을 시도했습니다.
이미지분야에서 주로 사용되는 contrastive learning (대조학습) 방법을 적용했습니다.

대조학습의 기본적인 개념은 비슷한 건 비슷한 벡터로, 다른 건 다른 벡터를 가지도록 학습해나가는 것입니다. 
이미지에서는 이미지의 원본과 이미지의 변형본이 비슷한 벡터를 가지도록, 다른 이미지와는 다른 벡터를 가지도록 학습을 하게 됩니다.
이는 SimCLR과 같은 방법들의 컨셉입니다.

SimCLR과 같은 개념을 병변 탐지 task에도 적용한 논문들을 찾을 수 있었습니다.
구체적인 구현과정이나 코드는 공개되지 않았지만, 이 개념을 제가 푸는 문제에도 적용하고자 했습니다.

SimCLR의 경량화 버전이라고도 이해할 수 있는 MoCo를 통해 대조학습을 적용했습니다.
구현할 때 가장 어려웠던 점은 성능에 해상도와 batch size가 가장 중요한 역할을 하는데, 이를 위해서는 multi-gpu를 사용해야했습니다.
예를 들어 배치가 128이라면 4개의 gpu에 32개씩 나눠서 학습을 진행하도록 해야했습니다.
즉 nvidia 4090 이 4개가 있는 실험환경에서, 이를 전부 사용해야 이상적인 결과(논문과 비슷한 성능)가 나온다는 것입니다.

다중 GPU 분산 학습을 해본 경험이 없었기 때문에 이 부분에서 시행착오가 정말 많았습니다.
또한 GPU 사용률을 높이기 위해 병목 지점이 되는 이미지 augmentation과 같은 CPU 작업들을 최적화하는 작업도 필요했습니다.

결과적으로 성능 향상이 눈에 띄게 나타났습니다.
사실 구체적인 수치로 표시해야 하는데, 1년이라는 시간이 지나면서 정확한 수치는 기억나지 않습니다.
다만 random vs ImageNet vs CL 기반으로 비교했을 때, 분명히 CL이 가장 좋은 성능을 보였습니다.

---

## Multi-Task Learning

다음으로 Unet의 Encoder 부분을 풍부하게 학습시키기 위해 MTL을 적용했습니다.
MTL은 하나의 모델이 여러 작업을 동시에 학습하는 방법으로, 각 작업이 서로 다른 관점에서 특징을 학습하도록 도와줍니다.

구체적으로는 Encoder에 Segmentation을 위한 Decoder 외에 reconstruction을 위한 decoder도 추가했습니다.
이는 일반화 성능을 향상시켰는데, 그 이유를 분석해보면 $p(X)$ 자체를 추정하는 task가 추가되면서 encoder가 근본적인 패턴을 찾는 방향으로 학습이 유도되었기 때문입니다.
reconstruction task는 입력 이미지를 그대로 복원하는 작업으로, encoder가 이미지의 전반적인 구조와 특징을 더 잘 이해하도록 도와줍니다.

---

# 모델을 서빙할 때 했던 고민들

모델을 개발한 후에는 실제 서비스 환경에서 사용할 수 있도록 모델 서빙 작업을 진행했습니다.
추론에 최적화된 그래프 형태로 모델을 변환하고, Triton Server를 이용해 dynamic batching과 같은 고급 기능들을 쉽게 구현할 수 있었습니다.

다만 온프레미스 환경에 설정하면서 CUDA, PyTorch, Triton Server 버전들을 맞추는 과정에서 정말 많은 시행착오가 있었습니다.
의존성 충돌과 버전 호환성 문제로 인해 고통스러웠던 경험이지만, 이를 통해 실제 프로덕션 환경에서의 모델 서빙에 대한 깊은 이해를 얻을 수 있었습니다.

추론 성능은 서비스 상황에서의 예상 요청량을 분석하고, 이때 추론에 걸리는 시간(latency)을 계산하는 방식으로 평가했습니다.
제약조건은 대략 10장의 이미지를 처리하는데 1초 이내가 걸려야 했고, 이를 충분히 만족시킬 수 있었습니다.

돌이켜보면 단순히 PyTorch로 모델을 올려도 만족할 수 있는 수준의 제약조건이었기 때문에, 빠르게 서비스를 시작해야 했다면 Triton Server 없이도 충분했을 것 같습니다.
하지만 Triton Server를 도입한 것은 향후 확장성과 성능 최적화를 위한 좋은 경험이 되었습니다.

---

# 프로젝트의 한계점

이 프로젝트는 실패로 끝이 났습니다.
모델의 성능이 충분하지 않아서가 아니라, 사용자가 필요성을 느끼지 못했기 때문입니다.

더 자세히 설명하면, 소프트웨어 의료기기를 출시하는 데에는 많은 어려움이 있습니다.
그 중 하나는 의료기기 허가를 받는 데까지 많은 시간이 걸린다는 점입니다 (보통 2~4년 정도).

따라서 의료기기 허가를 받기 전에는 법을 피해서 서비스를 제공해야 합니다.
이때 "진단"을 해서는 안 되며, 진단을 위한 보조 정도만이 가능합니다.
따라서 이 프로젝트는 "보조"에 목적을 두고 시작되었습니다.

하지만 실제 사용자의 이야기를 들어보면 병변을 찾는 것이 그렇게 어려운 일이 아니고, 굳이 돈을 내고 보조 프로그램을 쓸 필요를 느끼지 못하고 있었습니다.
또한 불편한 UI를 감수하면서까지 기존의 방법을 벗어나 새로운 프로그램을 쓰고 싶지도 않았습니다.

조금 허무한 결론이지만, 열심히 모델을 만들고 서빙했지만 사용자가 필요로 하지 않았기 때문에 실패로 끝이 나게 되었습니다.

소프트웨어 의료기기를 개발할 때의 한계점과 실제 사용자에게 맞는 문제 정의가 필요하다는 것을 많이 느낄 수 있었습니다.

