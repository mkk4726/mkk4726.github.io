---
title: "OCR Pipeline System"
excerpt: "문서 이미지에서 텍스트를 추출하는 자동화된 OCR 파이프라인"
category: "Career"
tags: ["Python", "OCR", "Computer Vision", "Docker", "gRPC"]
---

- 기간 : 2024.06 ~ 2024.09 (4개월)
- 역할 : 시스템 기획부터 구현까지 모든 과정
- 결과 (성과) : 정확도 99%, 에러율 1% 미만의 안정적인 OCR 파이프라인 구축
- 비즈니스에 주는 영향 : 안정적인 데이터 수집 기반을 구축하여 서비스 개발 및 운영의 안정성 확보

## 프로젝트 개요 : 

병원 검사 결과 이미지에서 실시간으로 검사 결과 데이터를 추출해 데이터베이스에 적재하는 OCR 파이프라인 시스템을 설계하고 구현하는 프로젝트를 진행했습니다.
환자의 검사 결과를 바탕으로 "시력 교정 수술 추천 서비스"나 "렌즈 사이즈 추천 서비스"를 운영하고 있었기 떄문에, 안정적인 파이프라인을 구축해야만 안정적인 서비스를 운영할 수 있는 상황이었습니다.

<figure>
<img src="/post/Portfolio/OCR_pipeline.png" alt="OCR Pipeline" width="100%" />
<figcaption>그림1. OCR Pipeline 구조</figcaption>
</figure>

제가 구성한 파이프라인 구조는 그림1과 같습니다.
6가지 종류, 총 40~50대의 검사장비에서 검사를 진행하고 이를 실시간으로 OCR하고 추출된 데이터를 DB에 적재하게 됩니다. 

**파이프라인을 설계하면서 정의했던 목표는 크게 2가지입니다.**

1. 에러가 발생하지 않고 안정적인 상태
   - 안정적인 서비스 개발 및 운영을 위해서
2. 99% 이상의 OCR 정확도
   - "검사 결과"이기 때문에 OCR 오류가 치명적일 수 있음

**프로젝트가 끝나고 결과 혹은 성과는 다음과 같습니다.**

1. 에러율 1% 미만의 안정적인 파이프라인 구조
   - 기능과 역할이 명확하게 구분된 객체지향적인 코드 구조
   - 문제 이유와 범위가 명확하게 보이는 에러 로그
   - 지속적인 모니터링 시스템
   - 비동기구조 적용으로 속도 향상
   - 유닛 테스트와 타입 검증
2. 99% 이상의 OCR 정확도
   - 이미지 전처리를 통해 정확도 향상
   - 테스크의 특성을 활용해 최적화된 모델 사용 및 후처리 로직으로 목표 정확도 달성

이러한 결과를 얻기 위해 어떤 선택들을 했는지에 대해 정리했습니다.

## 프로젝트 시작할 때의 상황 : 

처음 프로젝트를 시작할 때의 상황은 전임자가 프로젝트르 진행하다가 중간에 떠난 상황이었습니다.
알 수 없는 에러로그가 쌓이고 있었고, OCR 모델의 정확도는 알 수 없었습니다.
어떤 문제를 해결하려고 해도 어디서 발생한 에러인지, 그 범위는 어디까지인지 알 수 없었습니다.
또 절차지향적으로, 정확히는 하나의 .py에 구조없이 구현된 코드들은 기능과 역할이 모호했습니다.

**목표를 달성하기 위해서는 코드 구조를 개선하며 에러를 잡아나가야 했고, OCR 모델 개선해야 했습니다.**

## 맞으면서 배우다, 객체지향 설계의 중요성 :

무자비하게 쌓인 코드들을 보면서, 머리로 이해했던 1기능 1함수 원칙이나 디자인 패턴 등 코드를 잘 짜기 위한 방법들을 마음으로 이해할 수 있었습니다.
여러 기능이 하나의 함수에 작성되어있고, 타입힌트도 전혀 작성되어있지 않은 코드를 이해하고 디버깅하는 과정은 굉장히 어려웠습니다.

하지만 이런 코드를 이해하고 고쳐나가는 과정은 코드를 작성하는 능력을 키우는데 굉장히 큰 도움이 됐습니다.
이해하기 쉽고 디버깅이 쉬운 코드를 작성하기 위한 나름의 규칙들을 세울 수 있었습니다.

1. 함수에는 꼭 하나의 기능만, 객체에는 하나의 역할만 부여하기
2. 객체 지향의 꽃은 추상화, 입력과 출력만 신경쓸 수 있도록

이를 고려해 코드를 작성했고 문제를 하나씩 고쳐나갈 수 있었습니다.
에러의 범위와 원인을 파악하기 쉬워졌고, 전체 문제를 작은 문제들로 쪼갤 수 있었습니다.

## 문제를 정확히 이해하기, 비동기 구조로 속도 향상 :

<figure>
<img src="/post/Portfolio/OCR_server_threadpool.png" alt="OCR Server 구조" width="80%" />
<figcaption>그림2. OCR Server 구조</figcaption>
</figure>

client와 server에서 실행되는 로직은 그림2와 같습니다.
처음 프로젝트를 인수인계 받을 때 동시에 여러 이미지를 처리하더라도 OCR 속도가 1초 미만이어야 한다고 했습니다.
그 이유는 Client 프로그램에서 Server로부터 응답이 늦게 오면, 그 다음에 진행되는 작업도 늦어지게 되고, 이는 고객에게 불편함을 주기 때문입니다.

Client에서 OCR 성공 여부를 확인할 필요가 있나? 에 대한 의문에서 시작했습니다.
이미지 송수신 여부만 확인하면 되기 때문에 주고 받을 성공여부에 대한 의미를 재정의했습니다.
그리고 Server에서의 역할을 구분했고, **OCR 과정이 속도가 오래걸리더라도 Client에는 영향을 미치지 않는 구조**로 재정의할 수 있었습니다.

## 런타임 에러 줄이기, pytest를 활용한 unit test와 mypy를 활용한 타입 검증 : 

안정적인 파이프라인을 운영하기 위해 런타임 에러를 줄일 수 있는 방법에 대해 고민했습니다.

런타임 에러를 줄이기 위해 사용한 방법은, pytest를 통한 unitest와 mypy를 이용한 타입 검증입니다.
작게 쪼개놓은 기능이나 역할들이 잘 수행되는지 unit test를 통해 미리 확인하고, 주고 받는 값들의 타입들이 맞는지 미리 확인하는 작업을 CI과정에서 진행했습니다.

이를 통해 어떤 기능을 추가하거나 수정했을 때 발생할 수 있는 런타임 에러들을 미리 검증하고 사전에 파악할 수 있었습니다.

## 문제에 특화된 모델 사용하기, OCR 정확도 확보 :

<figure>
<img src="/post/Portfolio/OCR_tritonserver.png" alt="OCR Model" width="50%" />
<figcaption>그림3. OCR Model</figcaption>
</figure>

안정적인 파이프라인이 어느정도 완성된 다음에는 99%이상의 OCR 정확도를 어떻게 달성할 수 있을지에 대한 고민을 했습니다.
이를 위해서 문제의 특징을 사용했습니다.

OCR은 크게 2단계로 구분됩니다. 위치를 찾는 Text Detection과 텍스트를 인식하는 Text Recognition입니다.
검사장비에서 생성되는 검사 이미지는 고정되니까 위치 정보를 사전에 정의해놓을 수 있었습니다.
따라서 텍스트를 인식하는 부분에 특화된 모델만이 필요했습니다.
여러 모델을 찾던 중 TrOCR이라는 오픈소스 모델을 발견했고, 이 모델이 개발된 동기가 Text Detection은 추후로미루고 Text Recognition에 특화된 모델 먼저 만들겠다는 것입니다.

이미지 전처리와 결과 후처리 작업을 추가하니, 200건정도로 구성한 테스트 셋에서 99%이상, 거의 100%에 가까운 정확도를 확인할 수 있었습니다.

모델 배포는 온프레미스로 진행했고, TritonServer를 사용했습니다.
TritonServer를 선택한 주요 이유는 동적 배치 처리와 동시성 관리를 쉽게 구현할 수 있고, 이를 통해 처리량을 달성할 수 있기 때문입니다.